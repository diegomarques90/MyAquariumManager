@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
<link rel="stylesheet" href="~/lib/datatables/datatables.min.css" asp-append-version="true" />
<script src="~/lib/datatables/datatables.min.js" asp-append-version="true"></script>

@{
    ViewData["Title"] = "Animais";
}

<div class="container d-flex">
    <div class="col-12 col-sm-9 mt-3">
        <h3>Animais Cadastrados</h3>
    </div>
    <div class="col-12 col-sm-3 mt-3 justify-content-end">
        <a asp-action="Cadastro" class="btn btn-outline-dark d-flex justify-content-center align-items-center">Cadastrar Animal<i class="fa fa-square-plus fa-2x"></i></a>
    </div>
</div>

<div class="container mt-4"></div>

<table id="table-animais" class="display" style="width: 100%">
    <thead>
        <tr>
            <th class="d-none">Id</th>
            <th>Nome</th>
            <th>Nome Científico</th>
            <th>Espécie</th>
            <th>Data Aquisição</th>
            <th>Local da Aquisição</th>
            <th>Tipo de Água</th>
            <th>Origem</th>
            <th>Ações</th>
        </tr>
    </thead>
</table>

<div class="container mt-3"></div>



<script>
    $(document).ready(function() {
        carregarTableAnimais();
    });

    const tipoDeAguaMap = {
        1: "Água Doce",
        2: "Água Salgada",
        3: "Salobra"
    }

    function carregarTableAnimais() {
        return $('#table-animais').DataTable({
            scrollY: 400,
            pageLength: 25,
            responsive: true,
            processing: true,
            serverSide: true,
            ordering: true,
            order: [[0, 'desc']],
            searching: false,
            paging: true,
            ajax: {
                url: "Animal/carregar-table-animais",
                type: "GET",
                datatype: "json"
            },
            columns: [
                { data: "id" }, 
                { data: "nome" },
                { data: "nomeCientifico" },
                { data: "especie" },
                { data: "dataAquisicao",
                  render: function (data, type, row) {
                    if (data) {
                        var date = new Date(data);
                        var dia = ('0' + date.getDate()).slice(-2);
                        var mes = ('0' + (date.getMonth() + 1)).slice(-2);
                        var ano = date.getFullYear();

                        return dia + '/' + mes + '/' + ano;
                    }

                    return '';
                  }
                },
                { data: "localAquisicao" },
                { data: "tipoDeAgua",
                  render: function (data, type, row) {
                      return tipoDeAguaMap[data] || 'Não Informado';
                  }
                },
                { data: "origem" },
                {
                    data: null,
                    defaultContent: '',
                    orderable: false,
                    width: '120px',
                    render: function (data, type, row) {
                        let animalId = row.id;
                        let html = '';
                        
                        html += '<a href="/Animal/Detalhes/' + animalId + '" class="btn btn-sm btn-action-hover-white btn-radius-100 me-1" title="Visualizar Detalhes">' +
                                '   <i class="fas fa-eye"></i>' + 
                                '</a>';

                        html += '<a href="/Animal/Editar/' + animalId + '" class="btn btn-sm btn-action-hover-white btn-radius-100 me-1" title="Editar">' +
                                '   <i class="fas fa-edit"></i>' +
                                '</a>';

                        html += '<a href="javascript:void(0);" onclick="excluirAnimal(\'' + animalId + '\')" class="btn btn-sm btn-action-hover-white btn-radius-100" title="Excluir">' +
                                '   <i class="fas fa-trash-alt"></i>' +
                                '</a>';

                        return html;
                    }
                }
            ],
            columnDefs: [
                {
                    targets: 0,
                    visible: false,
                    searchable: false
                }
            ]
        });
    }

    function excluirAnimal(animalId) {
        let excluirAnimalUrl = '@Url.Action("ExcluirAnimal", "Animal")';

        $.ajax({
            url: `${excluirAnimalUrl}/${animalId}`,
            type: 'DELETE',
            success: function(response) {
                if (response.success) {
                    toastr.success('Animal excluído com sucesso!', 'Sucesso');
                    $('#table-animais').DataTable().ajax.reload(null, false);
                } else {
                    response.errors.forEach(error => {
                        toastr.warning(error);
                    });
                }
            },
            error: function(xhr, status, errors) {
                if (errors && Array.isArray(errors)) {
                    errors.forEach(error => {
                        toastr.warning(error);
                    });
                }
                else if (xhr.responseJSON && Array.isArray(xhr.responseJSON.errors)) {
                    xhr.responseJSON.errors.forEach(error => {
                        toastr.warning(error);
                    });
                } else {
                    toastr.error('Ocorreu uma falha ao excluir o animal. Tente novamente mais tarde!');
                }

                console.log(`Ocorreu uma falha ao excluir o animal. ErrorInfo: ${xhr} + ${errors}`);
            }
        });
    }
</script>

